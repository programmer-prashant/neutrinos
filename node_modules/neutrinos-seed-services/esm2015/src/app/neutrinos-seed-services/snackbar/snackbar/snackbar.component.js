import { Component, EventEmitter, Input, Output } from '@angular/core';
import { NSnackbarService } from '../../n-snackbar.service';
export class SnackbarComponent {
    constructor(snackbarService) {
        this.snackbarService = snackbarService;
        this.max = 1;
        this.onAdd = new EventEmitter();
        this.onRemove = new EventEmitter();
        this.onClear = new EventEmitter();
        this.snacks = [];
        this.snackbarService.get()
            .subscribe(snack => {
            if (snack.action === 'add') {
                this.add(snack.data);
            }
            else if (snack.action === 'remove') {
                this.remove(snack.id);
            }
            else if (snack.action === 'clear') {
                this.clear();
            }
        });
    }
    add(snack) {
        let timeout;
        const id = this.uuid();
        if (this.max && this.max > 0 && this.snacks.length === this.max) {
            this.remove(this.snacks[0].id);
        }
        if (snack.timeout || this.timeout) {
            timeout = setTimeout(() => {
                this.remove(id);
            }, snack.timeout || this.timeout);
        }
        const data = Object.assign({ id: id, timeoutObj: timeout }, snack);
        if (snack.action) {
            const that = this;
            const fcn = snack.action.onClick || new Function();
            snack.action.onClick = () => {
                fcn(data);
                that.remove(id);
            };
        }
        if (snack.onAdd) {
            snack.onAdd(data);
        }
        if (this.onAdd) {
            this.onAdd.emit(data);
        }
        this.snacks.push(data);
    }
    remove(id) {
        const snack = this.snacks.find(obj => obj.id === id);
        if (snack) {
            if (snack.onRemove) {
                snack.onRemove(snack);
            }
            if (this.onRemove) {
                this.onRemove.emit(snack);
            }
            if (snack.timeoutObj) {
                clearTimeout(snack.timeoutObj);
            }
        }
        this.snacks = this.snacks.filter(obj => obj.id !== id);
    }
    clear() {
        // this.snacks.forEach(snack => {
        //   this.remove(snack.id);
        // });
        this.snacks = [];
        if (this.onClear) {
            this.onClear.emit(true);
        }
    }
    uuid() {
        // tslint:disable:no-bitwise
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        // tslint:enable:no-bitwise
    }
    calcTextColor(background) {
        if (!background) {
            return null;
        }
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => {
                return r + r + g + g + b + b;
            });
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        const rgb = hexToRgb(background);
        if (!rgb) {
            return null;
        }
        const color = [rgb.r / 255, rgb.g / 255, rgb.b / 255];
        for (let i = 0; i < color.length; ++i) {
            if (color[i] <= 0.03928) {
                color[i] = color[i] / 12.92;
            }
            else {
                color[i] = Math.pow((color[i] + 0.055) / 1.055, 2.4);
            }
        }
        const l = 0.2126 * color[0] + 0.7152 * color[1] + 0.0722 * color[2];
        if (l > 0.179) {
            return '#000';
        }
        else {
            return '#fff';
        }
    }
}
SnackbarComponent.decorators = [
    { type: Component, args: [{
                selector: 'n-snackbar',
                template: `
      <div class="snackbars" [ngClass]="position || 'bottom-center'">
          <n-snack   *ngFor="let snackbar of snacks" [background]="snackbar.background || background"
                        [customClass]="snackbar.customClass || customClass"
                        [color]="snackbar.color || color || calcTextColor(snackbar.background || background)">
              <div class="container">
              <div class="snack-text child" >
                  {{snackbar.msg}}
              </div>
              <div *ngIf="snackbar.action.text" class="snack-action" (click)="snackbar.action.onClick()"
                   [ngStyle]="{color: snackbar.action.color || accent}">
                  {{snackbar.action.text}}
              </div>
              </div>
          </n-snack>
      </div>
  `,
                styles: [".snack-action{color:#2196f3;cursor:pointer;font-weight:700}.container{display:flex;flex-direction:row;flex-wrap:wrap}.child{flex:1 0;margin-right:.5em;width:60%}.snackbars.bottom-center{align-items:middle}.snackbars{display:flex;display:inline;font-family:Roboto;letter-spacing:1px;max-width:100%;position:fixed;word-wrap:break-word;z-index:99999}.snackbars.bottom-center{align-items:center;bottom:1px;left:50%;transform:translate(-50%)}.snack{border-radius:.3em;max-height:50vh;overflow:auto;padding:1em}"]
            },] }
];
SnackbarComponent.ctorParameters = () => [
    { type: NSnackbarService }
];
SnackbarComponent.propDecorators = {
    position: [{ type: Input }],
    max: [{ type: Input }],
    background: [{ type: Input }],
    accent: [{ type: Input }],
    color: [{ type: Input }],
    customClass: [{ type: Input }],
    timeout: [{ type: Input }],
    onAdd: [{ type: Output }],
    onRemove: [{ type: Output }],
    onClear: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hY2tiYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Ii9ob21lL25ldXRyaW5vcy9Eb2N1bWVudHMvbmV1dHJpbm9zLW1vZHVsZXMtYW5ndWxhci9uZXV0cmlub3Mtc2VlZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvc25hY2tiYXIvc25hY2tiYXIvc25hY2tiYXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUF1QjVELE1BQU0sT0FBTyxpQkFBaUI7SUFtQjVCLFlBQW9CLGVBQWlDO1FBQWpDLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQWpCNUMsUUFBRyxHQUFXLENBQUMsQ0FBQztRQU9SLFVBQUssR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUNuRCxhQUFRLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFDdEQsWUFBTyxHQUEwQixJQUFJLFlBQVksRUFBVyxDQUFDO1FBRTlFLFdBQU0sR0FJRCxFQUFFLENBQUM7UUFHTixJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRTthQUN2QixTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDakIsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLEtBQUssRUFBRTtnQkFDMUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDdEI7aUJBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLFFBQVEsRUFBRTtnQkFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDdkI7aUJBQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLE9BQU8sRUFBRTtnQkFDbkMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2Q7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxHQUFHLENBQUMsS0FBSztRQUNQLElBQUksT0FBTyxDQUFDO1FBQ1osTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXZCLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQy9ELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNoQztRQUVELElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pDLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUN4QixJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2xCLENBQUMsRUFBRSxLQUFLLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUNsQztRQUVELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVuRSxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFJLElBQUksUUFBUSxFQUFFLENBQUM7WUFDbkQsS0FBSyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsR0FBRyxFQUFFO2dCQUMxQixHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUM7U0FDSDtRQUVELElBQUksS0FBSyxDQUFDLEtBQUssRUFBRTtZQUNmLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkI7UUFFRCxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN2QjtRQUVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxNQUFNLENBQUMsRUFBRTtRQUNQLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUVyRCxJQUFJLEtBQUssRUFBRTtZQUNULElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDbEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUN2QjtZQUVELElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDM0I7WUFFRCxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUU7Z0JBQ3BCLFlBQVksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7YUFDaEM7U0FDRjtRQUVELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCxLQUFLO1FBQ0gsaUNBQWlDO1FBQ2pDLDJCQUEyQjtRQUMzQixNQUFNO1FBRU4sSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFFakIsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2hCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3pCO0lBQ0gsQ0FBQztJQUVELElBQUk7UUFDRiw0QkFBNEI7UUFDNUIsT0FBTyxzQ0FBc0MsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQztZQUN4RSxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDdEUsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsMkJBQTJCO0lBQzdCLENBQUM7SUFFRCxhQUFhLENBQUMsVUFBVTtRQUN0QixJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELFNBQVMsUUFBUSxDQUFDLEdBQUc7WUFDbkIsTUFBTSxjQUFjLEdBQUcsa0NBQWtDLENBQUM7WUFDMUQsR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0IsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLE1BQU0sR0FBRywyQ0FBMkMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckUsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNkLENBQUMsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDMUIsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUMxQixDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7YUFDM0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ1gsQ0FBQztRQUVELE1BQU0sR0FBRyxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1IsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE1BQU0sS0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUV0RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtZQUNyQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxPQUFPLEVBQUU7Z0JBQ3ZCLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQzdCO2lCQUFNO2dCQUNMLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxHQUFHLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQzthQUN0RDtTQUNGO1FBRUQsTUFBTSxDQUFDLEdBQUcsTUFBTSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFcEUsSUFBSSxDQUFDLEdBQUcsS0FBSyxFQUFFO1lBQ2IsT0FBTyxNQUFNLENBQUM7U0FDZjthQUFNO1lBQ0wsT0FBTyxNQUFNLENBQUM7U0FDZjtJQUNILENBQUM7OztZQTNLRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFlBQVk7Z0JBQ3RCLFFBQVEsRUFBRTs7Ozs7Ozs7Ozs7Ozs7OztHQWdCVDs7YUFFRjs7O1lBdEJRLGdCQUFnQjs7O3VCQXdCdEIsS0FBSztrQkFDTCxLQUFLO3lCQUNMLEtBQUs7cUJBQ0wsS0FBSztvQkFDTCxLQUFLOzBCQUNMLEtBQUs7c0JBQ0wsS0FBSztvQkFFTCxNQUFNO3VCQUNOLE1BQU07c0JBQ04sTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOU25hY2tiYXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbi1zbmFja2Jhci5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbi1zbmFja2JhcicsXG4gIHRlbXBsYXRlOiBgXG4gICAgICA8ZGl2IGNsYXNzPVwic25hY2tiYXJzXCIgW25nQ2xhc3NdPVwicG9zaXRpb24gfHwgJ2JvdHRvbS1jZW50ZXInXCI+XG4gICAgICAgICAgPG4tc25hY2sgICAqbmdGb3I9XCJsZXQgc25hY2tiYXIgb2Ygc25hY2tzXCIgW2JhY2tncm91bmRdPVwic25hY2tiYXIuYmFja2dyb3VuZCB8fCBiYWNrZ3JvdW5kXCJcbiAgICAgICAgICAgICAgICAgICAgICAgIFtjdXN0b21DbGFzc109XCJzbmFja2Jhci5jdXN0b21DbGFzcyB8fCBjdXN0b21DbGFzc1wiXG4gICAgICAgICAgICAgICAgICAgICAgICBbY29sb3JdPVwic25hY2tiYXIuY29sb3IgfHwgY29sb3IgfHwgY2FsY1RleHRDb2xvcihzbmFja2Jhci5iYWNrZ3JvdW5kIHx8IGJhY2tncm91bmQpXCI+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjb250YWluZXJcIj5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInNuYWNrLXRleHQgY2hpbGRcIiA+XG4gICAgICAgICAgICAgICAgICB7e3NuYWNrYmFyLm1zZ319XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICA8ZGl2ICpuZ0lmPVwic25hY2tiYXIuYWN0aW9uLnRleHRcIiBjbGFzcz1cInNuYWNrLWFjdGlvblwiIChjbGljayk9XCJzbmFja2Jhci5hY3Rpb24ub25DbGljaygpXCJcbiAgICAgICAgICAgICAgICAgICBbbmdTdHlsZV09XCJ7Y29sb3I6IHNuYWNrYmFyLmFjdGlvbi5jb2xvciB8fCBhY2NlbnR9XCI+XG4gICAgICAgICAgICAgICAgICB7e3NuYWNrYmFyLmFjdGlvbi50ZXh0fX1cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvbi1zbmFjaz5cbiAgICAgIDwvZGl2PlxuICBgLFxuICBzdHlsZVVybHM6IFsnLi9zbmFja2Jhci5zdHlsZS5jc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBTbmFja2JhckNvbXBvbmVudCB7XG4gIEBJbnB1dCgpIHBvc2l0aW9uOiAndG9wLWxlZnQnIHwgJ3RvcC1jZW50ZXInIHwgJ3RvcC1yaWdodCcgfCAnYm90dG9tLWxlZnQnIHwgJ2JvdHRvbS1jZW50ZXInIHwgJ2JvdHRvbS1yaWdodCc7XG4gIEBJbnB1dCgpIG1heDogbnVtYmVyID0gMTtcbiAgQElucHV0KCkgYmFja2dyb3VuZDogc3RyaW5nO1xuICBASW5wdXQoKSBhY2NlbnQ6IHN0cmluZztcbiAgQElucHV0KCkgY29sb3I6IHN0cmluZztcbiAgQElucHV0KCkgY3VzdG9tQ2xhc3M6IGFueTtcbiAgQElucHV0KCkgdGltZW91dDogbnVtYmVyO1xuXG4gIEBPdXRwdXQoKSBwdWJsaWMgb25BZGQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25SZW1vdmU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25DbGVhcjogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuXG4gIHNuYWNrczogQXJyYXk8e1xuICAgIGlkOiBzdHJpbmcsIG1zZzogc3RyaW5nLCB0aW1lb3V0PzogbnVtYmVyLCBjb2xvcj86IHN0cmluZywgYmFja2dyb3VuZD86IHN0cmluZywgY3VzdG9tQ2xhc3M/OiBhbnksIGFjdGlvbj86IHtcbiAgICAgIHRleHQ6IHN0cmluZywgb25DbGljaz86IEZ1bmN0aW9uLCBjb2xvcj86IHN0cmluZ1xuICAgIH0sIG9uQWRkPzogRnVuY3Rpb24sIG9uUmVtb3ZlPzogRnVuY3Rpb24sIHRpbWVvdXRPYmo/OiBhbnlcbiAgfT4gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNuYWNrYmFyU2VydmljZTogTlNuYWNrYmFyU2VydmljZSkge1xuICAgIHRoaXMuc25hY2tiYXJTZXJ2aWNlLmdldCgpXG4gICAgICAuc3Vic2NyaWJlKHNuYWNrID0+IHtcbiAgICAgICAgaWYgKHNuYWNrLmFjdGlvbiA9PT0gJ2FkZCcpIHtcbiAgICAgICAgICB0aGlzLmFkZChzbmFjay5kYXRhKTtcbiAgICAgICAgfSBlbHNlIGlmIChzbmFjay5hY3Rpb24gPT09ICdyZW1vdmUnKSB7XG4gICAgICAgICAgdGhpcy5yZW1vdmUoc25hY2suaWQpO1xuICAgICAgICB9IGVsc2UgaWYgKHNuYWNrLmFjdGlvbiA9PT0gJ2NsZWFyJykge1xuICAgICAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBhZGQoc25hY2spIHtcbiAgICBsZXQgdGltZW91dDtcbiAgICBjb25zdCBpZCA9IHRoaXMudXVpZCgpO1xuXG4gICAgaWYgKHRoaXMubWF4ICYmIHRoaXMubWF4ID4gMCAmJiB0aGlzLnNuYWNrcy5sZW5ndGggPT09IHRoaXMubWF4KSB7XG4gICAgICB0aGlzLnJlbW92ZSh0aGlzLnNuYWNrc1swXS5pZCk7XG4gICAgfVxuXG4gICAgaWYgKHNuYWNrLnRpbWVvdXQgfHwgdGhpcy50aW1lb3V0KSB7XG4gICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMucmVtb3ZlKGlkKTtcbiAgICAgIH0sIHNuYWNrLnRpbWVvdXQgfHwgdGhpcy50aW1lb3V0KVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHsgaWQ6IGlkLCB0aW1lb3V0T2JqOiB0aW1lb3V0IH0sIHNuYWNrKTtcblxuICAgIGlmIChzbmFjay5hY3Rpb24pIHtcbiAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgICAgY29uc3QgZmNuID0gc25hY2suYWN0aW9uLm9uQ2xpY2sgfHwgbmV3IEZ1bmN0aW9uKCk7XG4gICAgICBzbmFjay5hY3Rpb24ub25DbGljayA9ICgpID0+IHtcbiAgICAgICAgZmNuKGRhdGEpO1xuICAgICAgICB0aGF0LnJlbW92ZShpZCk7XG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChzbmFjay5vbkFkZCkge1xuICAgICAgc25hY2sub25BZGQoZGF0YSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMub25BZGQpIHtcbiAgICAgIHRoaXMub25BZGQuZW1pdChkYXRhKTtcbiAgICB9XG5cbiAgICB0aGlzLnNuYWNrcy5wdXNoKGRhdGEpO1xuICB9XG5cbiAgcmVtb3ZlKGlkKSB7XG4gICAgY29uc3Qgc25hY2sgPSB0aGlzLnNuYWNrcy5maW5kKG9iaiA9PiBvYmouaWQgPT09IGlkKTtcblxuICAgIGlmIChzbmFjaykge1xuICAgICAgaWYgKHNuYWNrLm9uUmVtb3ZlKSB7XG4gICAgICAgIHNuYWNrLm9uUmVtb3ZlKHNuYWNrKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMub25SZW1vdmUpIHtcbiAgICAgICAgdGhpcy5vblJlbW92ZS5lbWl0KHNuYWNrKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHNuYWNrLnRpbWVvdXRPYmopIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHNuYWNrLnRpbWVvdXRPYmopO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc25hY2tzID0gdGhpcy5zbmFja3MuZmlsdGVyKG9iaiA9PiBvYmouaWQgIT09IGlkKTtcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIC8vIHRoaXMuc25hY2tzLmZvckVhY2goc25hY2sgPT4ge1xuICAgIC8vICAgdGhpcy5yZW1vdmUoc25hY2suaWQpO1xuICAgIC8vIH0pO1xuXG4gICAgdGhpcy5zbmFja3MgPSBbXTtcblxuICAgIGlmICh0aGlzLm9uQ2xlYXIpIHtcbiAgICAgIHRoaXMub25DbGVhci5lbWl0KHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIHV1aWQoKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGU6bm8tYml0d2lzZVxuICAgIHJldHVybiAneHh4eHh4eHgteHh4eC00eHh4LXl4eHgteHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beHldL2csIGZ1bmN0aW9uIChjKSB7XG4gICAgICBjb25zdCByID0gTWF0aC5yYW5kb20oKSAqIDE2IHwgMCwgdiA9IGMgPT09ICd4JyA/IHIgOiAociAmIDB4MyB8IDB4OCk7XG4gICAgICByZXR1cm4gdi50b1N0cmluZygxNik7XG4gICAgfSk7XG4gICAgLy8gdHNsaW50OmVuYWJsZTpuby1iaXR3aXNlXG4gIH1cblxuICBjYWxjVGV4dENvbG9yKGJhY2tncm91bmQpIHtcbiAgICBpZiAoIWJhY2tncm91bmQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGhleFRvUmdiKGhleCkge1xuICAgICAgY29uc3Qgc2hvcnRoYW5kUmVnZXggPSAvXiM/KFthLWZcXGRdKShbYS1mXFxkXSkoW2EtZlxcZF0pJC9pO1xuICAgICAgaGV4ID0gaGV4LnJlcGxhY2Uoc2hvcnRoYW5kUmVnZXgsIChtLCByLCBnLCBiKSA9PiB7XG4gICAgICAgIHJldHVybiByICsgciArIGcgKyBnICsgYiArIGI7XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gL14jPyhbYS1mXFxkXXsyfSkoW2EtZlxcZF17Mn0pKFthLWZcXGRdezJ9KSQvaS5leGVjKGhleCk7XG4gICAgICByZXR1cm4gcmVzdWx0ID8ge1xuICAgICAgICByOiBwYXJzZUludChyZXN1bHRbMV0sIDE2KSxcbiAgICAgICAgZzogcGFyc2VJbnQocmVzdWx0WzJdLCAxNiksXG4gICAgICAgIGI6IHBhcnNlSW50KHJlc3VsdFszXSwgMTYpXG4gICAgICB9IDogbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCByZ2IgPSBoZXhUb1JnYihiYWNrZ3JvdW5kKTtcbiAgICBpZiAoIXJnYikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgY29sb3IgPSBbcmdiLnIgLyAyNTUsIHJnYi5nIC8gMjU1LCByZ2IuYiAvIDI1NV07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbG9yLmxlbmd0aDsgKytpKSB7XG4gICAgICBpZiAoY29sb3JbaV0gPD0gMC4wMzkyOCkge1xuICAgICAgICBjb2xvcltpXSA9IGNvbG9yW2ldIC8gMTIuOTI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb2xvcltpXSA9IE1hdGgucG93KChjb2xvcltpXSArIDAuMDU1KSAvIDEuMDU1LCAyLjQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGwgPSAwLjIxMjYgKiBjb2xvclswXSArIDAuNzE1MiAqIGNvbG9yWzFdICsgMC4wNzIyICogY29sb3JbMl07XG5cbiAgICBpZiAobCA+IDAuMTc5KSB7XG4gICAgICByZXR1cm4gJyMwMDAnO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJyNmZmYnO1xuICAgIH1cbiAgfVxufVxuIl19
import { Injectable } from '@angular/core';
import { NSystemService } from './n-system.service';
import { NLocalStorageService } from './n-localStorage.service';
import firebase from 'firebase';
import { NPubSubService } from './n-pubSub.service';
import { HttpClient } from '@angular/common/http';
import { NSessionStorageService } from './n-sessionStorage.service';
// import { Router } from '@angular/router';
import { NHTTPLoaderService } from './n-HTTPLoader.service';
export class NNotificationService {
    constructor(localStorageService, pubSubService, http, bHttpLoader) {
        this.localStorageService = localStorageService;
        this.pubSubService = pubSubService;
        this.http = http;
        this.bHttpLoader = bHttpLoader;
        // private static instance: NNotificationService;
        this.systemService = NSystemService.getInstance();
        this.possiblePushTypes = ['APNS', 'FCM'];
        this.firebaseSenderId = this.systemService.getVal('firebaseSenderId');
        this.isNotificationEnabled = this.systemService.getVal('isNotificationEnabled');
        this.appName = this.systemService.getVal('appName');
        this.deviceType = this.systemService.deviceType;
        this.sessionStorage = new NSessionStorageService();
        this.loginSubscribe = this.pubSubService.$sub('firebaseRegister', () => {
            this.enableNotification();
        });
    }
    ngOnInit() {
    }
    enableNotification() {
        let pushType = this.getPushType(this.systemService.getVal('pushType'));
        document.addEventListener('deviceready', event => {
            if (this.isNotificationEnabled) {
                if (this.deviceType && this.deviceType != 'browser') {
                    this.deviceType = this.systemService.deviceType;
                    this.checkPermission(pushType).then(res => {
                        if (res) {
                            this.initializeNotifications(pushType);
                        }
                    });
                }
            }
        });
        if (this.isNotificationEnabled && pushType !== 'APNS') {
            if (this.deviceType && this.deviceType == 'browser' && window['Notification']) {
                this.initialiseWebPush();
            }
        }
    }
    initialiseWebPush() {
        const __this = this;
        const messaging = firebase.messaging();
        Notification.requestPermission()
            .then(function () {
            return messaging.getToken();
        })
            .then(function (token) {
            if (token) {
                __this.sendRegDetails(token);
            }
        })
            .catch(function (err) {
            __this.bHttpLoader.alertError(err);
        });
        messaging.onMessage(function (payload) {
            if (payload['notification']) {
                let notificationObj = payload['notification'];
                let options = {
                    body: notificationObj.body,
                    icon: notificationObj.icon
                };
                // creating a native browser message
                let notificationUI = new Notification(notificationObj.title, options);
                notificationUI.onclick = function () {
                    window.focus(); // window is focused when the user clicks the notification using this
                };
            }
        });
    }
    checkPermission(pushType) {
        // Android & iOS only
        // Checks whether the push notification permission has been granted.
        return new Promise((resolve) => {
            pushType = this.getPushType(pushType);
            if ((this.deviceType === 'Android' || this.deviceType === 'iOS') && (pushType === 'FCM')) {
                PushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else if (this.deviceType === 'iOS' && pushType === 'APNS') {
                APNSPushNotification.hasPermission(function (data) {
                    return resolve(data.isEnabled);
                });
            }
            else {
                return resolve(true);
            }
        });
    }
    initializeNotifications(pushType) {
        //pushType = pushType ? pushType : 'FCM';
        pushType = this.getPushType(pushType);
        let push;
        // Default if for FCM
        if (pushType === 'FCM') {
            push = window['PushNotification'].init({
                android: {
                    senderID: this.firebaseSenderId
                },
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true",
                    senderID: this.firebaseSenderId
                },
            });
        }
        // New APNS plugin init
        else if (pushType === 'APNS') {
            push = window['APNSPushNotification'].init({
                ios: {
                    alert: "true",
                    badge: "true",
                    sound: "true"
                }
            });
        }
        push.on('registration', (data) => {
            // data.registrationId
            this.sendRegDetails(data.registrationId);
        });
        // ToDo Christy get call back function from app user to change what happens once a notification arrives
        push.on('notification', (data) => {
            window['cordova'].plugins.notification.local.schedule({
                title: data.title,
                text: data.message,
                sound: data.sound,
                at: new Date().getTime()
            });
        });
        push.on('error', (e) => {
            // e.message
            console.error(e);
        });
    }
    sendRegDetails(registrationId) {
        this.localStorageService.setValue('registrationId', registrationId);
        var url = this.systemService.getTenantUrl() + 'notification/' + this.systemService.getVal('appName') + '/register';
        let pushType = this.getPushType(this.systemService.getVal('pushType'));
        this.http.post(url, {
            'key': this.sessionStorage.getValue('userObj')['userKey'],
            'uuid': this.localStorageService.getValue('uuid'),
            'fbregid': registrationId,
            'pushType': pushType
        }).subscribe(result => {
            // this.pubSubService.$pub('FBRegComp');
        }, error => {
            console.log(error);
        });
    }
    getPushType(currPushType) {
        let isValidPush = typeof currPushType !== 'undefined' && this.possiblePushTypes.includes(currPushType.toUpperCase());
        let pushType = isValidPush ? currPushType.toUpperCase() : 'FCM';
        return pushType;
    }
    ngOnDestroy() {
        this.loginSubscribe.unSubscribe();
    }
}
NNotificationService.decorators = [
    { type: Injectable }
];
NNotificationService.ctorParameters = () => [
    { type: NLocalStorageService },
    { type: NPubSubService },
    { type: HttpClient },
    { type: NHTTPLoaderService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1ub3RpZmljYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9uZXV0cmlub3MvRG9jdW1lbnRzL25ldXRyaW5vcy1tb2R1bGVzLWFuZ3VsYXIvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL24tbm90aWZpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBcUIsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBSXBELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLE9BQU8sUUFBUSxNQUFNLFVBQVUsQ0FBQztBQUNoQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BFLDRDQUE0QztBQUM1QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUs1RCxNQUFNLE9BQU8sb0JBQW9CO0lBWS9CLFlBQW9CLG1CQUF5QyxFQUFVLGFBQTZCLEVBQzFGLElBQWdCLEVBQVUsV0FBK0I7UUFEL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFnQjtRQUMxRixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBWm5FLGlEQUFpRDtRQUN6QyxrQkFBYSxHQUFtQixjQUFjLENBQUMsV0FBVyxFQUFFLENBQUM7UUFNN0Qsc0JBQWlCLEdBQWEsQ0FBQyxNQUFNLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFNbkQsSUFBSSxDQUFDLGdCQUFnQixH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WSxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ3JILElBQUksUUFBUSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDaEUsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3BDLENBQUM7OztZQWhMRixVQUFVOzs7WUFWRixvQkFBb0I7WUFFcEIsY0FBYztZQUNkLFVBQVU7WUFHVixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTlN5c3RlbVNlcnZpY2UgfSBmcm9tICcuL24tc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuZGVjbGFyZSB2YXIgUHVzaE5vdGlmaWNhdGlvbjogYW55O1xuZGVjbGFyZSB2YXIgQVBOU1B1c2hOb3RpZmljYXRpb246IGFueTtcbmltcG9ydCB7IE5Mb2NhbFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9uLWxvY2FsU3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCBmaXJlYmFzZSBmcm9tICdmaXJlYmFzZSc7XG5pbXBvcnQgeyBOUHViU3ViU2VydmljZSB9IGZyb20gJy4vbi1wdWJTdWIuc2VydmljZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgTlNlc3Npb25TdG9yYWdlU2VydmljZSB9IGZyb20gJy4vbi1zZXNzaW9uU3RvcmFnZS5zZXJ2aWNlJztcbi8vIGltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBOSFRUUExvYWRlclNlcnZpY2UgfSBmcm9tICcuL24tSFRUUExvYWRlci5zZXJ2aWNlJztcbmltcG9ydCB7IGVudmlyb25tZW50IH0gZnJvbSAnLi4vLi4vZW52aXJvbm1lbnRzL2Vudmlyb25tZW50LnByb2QnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOTm90aWZpY2F0aW9uU2VydmljZSB7XG4gIC8vIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBOTm90aWZpY2F0aW9uU2VydmljZTtcbiAgcHJpdmF0ZSBzeXN0ZW1TZXJ2aWNlOiBOU3lzdGVtU2VydmljZSA9IE5TeXN0ZW1TZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gIHByaXZhdGUgZmlyZWJhc2VTZW5kZXJJZDogc3RyaW5nO1xuICBwcml2YXRlIGlzTm90aWZpY2F0aW9uRW5hYmxlZDogYm9vbGVhbjtcbiAgcHJpdmF0ZSBkZXZpY2VUeXBlOyBzdHJpbmc7XG4gIHByaXZhdGUgcmVzRGV0YWlscztcbiAgcHJpdmF0ZSBkZXZpY2VVVUlEOiBzdHJpbmc7XG4gIHByaXZhdGUgcG9zc2libGVQdXNoVHlwZXM6IHN0cmluZ1tdID0gWydBUE5TJywnRkNNJ107XG4gIGxvZ2luU3Vic2NyaWJlO1xuICBzZXNzaW9uU3RvcmFnZTogTlNlc3Npb25TdG9yYWdlU2VydmljZTtcbiAgYXBwTmFtZTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhbFN0b3JhZ2VTZXJ2aWNlOiBOTG9jYWxTdG9yYWdlU2VydmljZSwgcHJpdmF0ZSBwdWJTdWJTZXJ2aWNlOiBOUHViU3ViU2VydmljZSxcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIHByaXZhdGUgYkh0dHBMb2FkZXI6IE5IVFRQTG9hZGVyU2VydmljZSkge1xuICAgIHRoaXMuZmlyZWJhc2VTZW5kZXJJZCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2ZpcmViYXNlU2VuZGVySWQnKTtcbiAgICB0aGlzLmlzTm90aWZpY2F0aW9uRW5hYmxlZCA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2lzTm90aWZpY2F0aW9uRW5hYmxlZCcpO1xuICAgIHRoaXMuYXBwTmFtZSA9IHRoaXMuc3lzdGVtU2VydmljZS5nZXRWYWwoJ2FwcE5hbWUnKTtcbiAgICB0aGlzLmRldmljZVR5cGUgPSB0aGlzLnN5c3RlbVNlcnZpY2UuZGV2aWNlVHlwZTtcbiAgICB0aGlzLnNlc3Npb25TdG9yYWdlID0gbmV3IE5TZXNzaW9uU3RvcmFnZVNlcnZpY2UoKTtcbiAgICB0aGlzLmxvZ2luU3Vic2NyaWJlID0gdGhpcy5wdWJTdWJTZXJ2aWNlLiRzdWIoJ2ZpcmViYXNlUmVnaXN0ZXInLCAoKSA9PiB7XG4gICAgICB0aGlzLmVuYWJsZU5vdGlmaWNhdGlvbigpO1xuICAgIH0pXG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG5cbiAgZW5hYmxlTm90aWZpY2F0aW9uKCkge1xuICAgIGxldCBwdXNoVHlwZSA9IHRoaXMuZ2V0UHVzaFR5cGUodGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgncHVzaFR5cGUnKSk7XG4gICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZGV2aWNlcmVhZHknLCBldmVudCA9PiB7XG4gICAgICBpZiAodGhpcy5pc05vdGlmaWNhdGlvbkVuYWJsZWQpIHtcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlVHlwZSAmJiB0aGlzLmRldmljZVR5cGUgIT0gJ2Jyb3dzZXInKSB7XG4gICAgICAgICAgdGhpcy5kZXZpY2VUeXBlID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmRldmljZVR5cGU7XG4gICAgICAgICAgdGhpcy5jaGVja1Blcm1pc3Npb24ocHVzaFR5cGUpLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgIGlmIChyZXMpIHtcbiAgICAgICAgICAgICAgdGhpcy5pbml0aWFsaXplTm90aWZpY2F0aW9ucyhwdXNoVHlwZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodGhpcy5pc05vdGlmaWNhdGlvbkVuYWJsZWQgJiYgcHVzaFR5cGUgIT09ICdBUE5TJykge1xuICAgICAgaWYgKHRoaXMuZGV2aWNlVHlwZSAmJiB0aGlzLmRldmljZVR5cGUgPT0gJ2Jyb3dzZXInICYmIHdpbmRvd1snTm90aWZpY2F0aW9uJ10pIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXNlV2ViUHVzaCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpc2VXZWJQdXNoKCkge1xuICAgIGNvbnN0IF9fdGhpcyA9IHRoaXM7XG4gICAgY29uc3QgbWVzc2FnaW5nID0gZmlyZWJhc2UubWVzc2FnaW5nKCk7XG5cbiAgICBOb3RpZmljYXRpb24ucmVxdWVzdFBlcm1pc3Npb24oKVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gbWVzc2FnaW5nLmdldFRva2VuKCk7XG4gICAgICB9KVxuICAgICAgLnRoZW4oZnVuY3Rpb24gKHRva2VuKSB7XG4gICAgICAgIGlmICh0b2tlbikge1xuICAgICAgICAgIF9fdGhpcy5zZW5kUmVnRGV0YWlscyh0b2tlbik7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICBfX3RoaXMuYkh0dHBMb2FkZXIuYWxlcnRFcnJvcihlcnIpO1xuICAgICAgfSk7XG5cbiAgICBtZXNzYWdpbmcub25NZXNzYWdlKGZ1bmN0aW9uIChwYXlsb2FkKSB7XG4gICAgICBpZiAocGF5bG9hZFsnbm90aWZpY2F0aW9uJ10pIHtcbiAgICAgICAgbGV0IG5vdGlmaWNhdGlvbk9iaiA9IHBheWxvYWRbJ25vdGlmaWNhdGlvbiddO1xuICAgICAgICBsZXQgb3B0aW9ucyA9IHtcbiAgICAgICAgICBib2R5OiBub3RpZmljYXRpb25PYmouYm9keSxcbiAgICAgICAgICBpY29uOiBub3RpZmljYXRpb25PYmouaWNvblxuICAgICAgICB9XG4gICAgICAgIC8vIGNyZWF0aW5nIGEgbmF0aXZlIGJyb3dzZXIgbWVzc2FnZVxuICAgICAgICBsZXQgbm90aWZpY2F0aW9uVUkgPSBuZXcgTm90aWZpY2F0aW9uKG5vdGlmaWNhdGlvbk9iai50aXRsZSwgb3B0aW9ucyk7XG4gICAgICAgIG5vdGlmaWNhdGlvblVJLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgd2luZG93LmZvY3VzKCk7IC8vIHdpbmRvdyBpcyBmb2N1c2VkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIHRoZSBub3RpZmljYXRpb24gdXNpbmcgdGhpc1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBjaGVja1Blcm1pc3Npb24ocHVzaFR5cGU/KSB7XG4gICAgLy8gQW5kcm9pZCAmIGlPUyBvbmx5XG4gICAgLy8gQ2hlY2tzIHdoZXRoZXIgdGhlIHB1c2ggbm90aWZpY2F0aW9uIHBlcm1pc3Npb24gaGFzIGJlZW4gZ3JhbnRlZC5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZShwdXNoVHlwZSk7XG4gICAgICBpZiAoKHRoaXMuZGV2aWNlVHlwZSA9PT0gJ0FuZHJvaWQnIHx8IHRoaXMuZGV2aWNlVHlwZSA9PT0gJ2lPUycpICYmIChwdXNoVHlwZSA9PT0gJ0ZDTScgKSkge1xuICAgICAgICBQdXNoTm90aWZpY2F0aW9uLmhhc1Blcm1pc3Npb24oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhLmlzRW5hYmxlZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLmRldmljZVR5cGUgPT09ICdpT1MnICYmIHB1c2hUeXBlID09PSAnQVBOUycpIHtcbiAgICAgICAgIEFQTlNQdXNoTm90aWZpY2F0aW9uLmhhc1Blcm1pc3Npb24oZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhLmlzRW5hYmxlZCk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUodHJ1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBpbml0aWFsaXplTm90aWZpY2F0aW9ucyhwdXNoVHlwZT8pIHtcbiAgICAvL3B1c2hUeXBlID0gcHVzaFR5cGUgPyBwdXNoVHlwZSA6ICdGQ00nO1xuICAgIHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZShwdXNoVHlwZSk7XG5cbiAgICBsZXQgcHVzaDtcbiAgICAvLyBEZWZhdWx0IGlmIGZvciBGQ01cbiAgICBpZiAocHVzaFR5cGUgPT09ICdGQ00nKSB7XG4gICAgICBwdXNoID0gd2luZG93WydQdXNoTm90aWZpY2F0aW9uJ10uaW5pdCh7XG4gICAgICAgIGFuZHJvaWQ6IHtcbiAgICAgICAgICBzZW5kZXJJRDogdGhpcy5maXJlYmFzZVNlbmRlcklkXG4gICAgICAgIH0sXG4gICAgICAgIGlvczoge1xuICAgICAgICAgIGFsZXJ0OiBcInRydWVcIixcbiAgICAgICAgICBiYWRnZTogXCJ0cnVlXCIsXG4gICAgICAgICAgc291bmQ6IFwidHJ1ZVwiLFxuICAgICAgICAgIHNlbmRlcklEOiB0aGlzLmZpcmViYXNlU2VuZGVySWRcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBOZXcgQVBOUyBwbHVnaW4gaW5pdFxuICAgIGVsc2UgaWYgKHB1c2hUeXBlID09PSAnQVBOUycpIHtcbiAgICAgIHB1c2ggPSB3aW5kb3dbJ0FQTlNQdXNoTm90aWZpY2F0aW9uJ10uaW5pdCh7XG4gICAgICAgIGlvczoge1xuICAgICAgICAgIGFsZXJ0OiBcInRydWVcIixcbiAgICAgICAgICBiYWRnZTogXCJ0cnVlXCIsXG4gICAgICAgICAgc291bmQ6IFwidHJ1ZVwiXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICBwdXNoLm9uKCdyZWdpc3RyYXRpb24nLCAoZGF0YSkgPT4ge1xuICAgICAgLy8gZGF0YS5yZWdpc3RyYXRpb25JZFxuICAgICAgdGhpcy5zZW5kUmVnRGV0YWlscyhkYXRhLnJlZ2lzdHJhdGlvbklkKTtcbiAgICB9KTtcblxuICAgIC8vIFRvRG8gQ2hyaXN0eSBnZXQgY2FsbCBiYWNrIGZ1bmN0aW9uIGZyb20gYXBwIHVzZXIgdG8gY2hhbmdlIHdoYXQgaGFwcGVucyBvbmNlIGEgbm90aWZpY2F0aW9uIGFycml2ZXNcbiAgICBwdXNoLm9uKCdub3RpZmljYXRpb24nLCAoZGF0YSkgPT4ge1xuICAgICAgd2luZG93Wydjb3Jkb3ZhJ10ucGx1Z2lucy5ub3RpZmljYXRpb24ubG9jYWwuc2NoZWR1bGUoe1xuICAgICAgICB0aXRsZTogZGF0YS50aXRsZSxcbiAgICAgICAgdGV4dDogZGF0YS5tZXNzYWdlLFxuICAgICAgICBzb3VuZDogZGF0YS5zb3VuZCxcbiAgICAgICAgYXQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHB1c2gub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICAgIC8vIGUubWVzc2FnZVxuICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHNlbmRSZWdEZXRhaWxzKHJlZ2lzdHJhdGlvbklkKSB7XG4gICAgdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLnNldFZhbHVlKCdyZWdpc3RyYXRpb25JZCcsIHJlZ2lzdHJhdGlvbklkKTtcbiAgICB2YXIgdXJsID0gdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFRlbmFudFVybCgpICsgJ25vdGlmaWNhdGlvbi8nICsgdGhpcy5zeXN0ZW1TZXJ2aWNlLmdldFZhbCgnYXBwTmFtZScpICsgJy9yZWdpc3Rlcic7XG4gICAgbGV0IHB1c2hUeXBlID0gdGhpcy5nZXRQdXNoVHlwZSh0aGlzLnN5c3RlbVNlcnZpY2UuZ2V0VmFsKCdwdXNoVHlwZScpKTtcbiAgICB0aGlzLmh0dHAucG9zdCh1cmwsIHtcbiAgICAgICdrZXknOiB0aGlzLnNlc3Npb25TdG9yYWdlLmdldFZhbHVlKCd1c2VyT2JqJylbJ3VzZXJLZXknXSxcbiAgICAgICd1dWlkJzogdGhpcy5sb2NhbFN0b3JhZ2VTZXJ2aWNlLmdldFZhbHVlKCd1dWlkJyksIFxuICAgICAgJ2ZicmVnaWQnOiByZWdpc3RyYXRpb25JZCxcbiAgICAgICdwdXNoVHlwZSc6IHB1c2hUeXBlXG4gICAgfSkuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAvLyB0aGlzLnB1YlN1YlNlcnZpY2UuJHB1YignRkJSZWdDb21wJyk7XG4gICAgfSwgZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xuICAgIH0pXG4gIH1cblxuICBnZXRQdXNoVHlwZSAoY3VyclB1c2hUeXBlKSB7XG4gICAgbGV0IGlzVmFsaWRQdXNoID0gdHlwZW9mIGN1cnJQdXNoVHlwZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdGhpcy5wb3NzaWJsZVB1c2hUeXBlcy5pbmNsdWRlcyhjdXJyUHVzaFR5cGUudG9VcHBlckNhc2UoKSk7XG4gICAgbGV0IHB1c2hUeXBlID0gaXNWYWxpZFB1c2ggPyBjdXJyUHVzaFR5cGUudG9VcHBlckNhc2UoKSA6ICdGQ00nO1xuICAgIHJldHVybiBwdXNoVHlwZTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMubG9naW5TdWJzY3JpYmUudW5TdWJzY3JpYmUoKTtcbiAgfVxufVxuIl19
import { NSystemService } from './n-system.service';
import { Injectable } from '@angular/core';
import { NgForage, NgForageCache, NgForageConfig, Driver } from 'ngforage';
import { NUtility } from './n-util.service';
export class NLocalStorageService {
    constructor(ngfConfig, ngf, ngfCache) {
        this.ngfConfig = ngfConfig;
        this.ngf = ngf;
        this.ngfCache = ngfCache;
        this.storageCache = {};
    }
    initStorage() {
        return new Promise((resolve, reject) => {
            if (window['cordova']) {
                this.initNgForage();
            }
            this.ngf.iterate((value, key, iteratonNumber) => {
                this.storageCache[key] = value;
            }).then(result => {
                this.checkDeviceId();
                return resolve('iteration is completed');
            }).catch(error => {
                return reject(error);
            });
        });
    }
    getStorage() {
        return this.storageCache;
    }
    setValue(key, value) {
        if (window['cordova']) {
            this.initNgForage();
        }
        this.storageCache[key] = value;
        return this.ngf.setItem(key, value).then(result => {
            return result;
        }, error => {
            console.log(error);
        });
    }
    getValue(key) {
        if (!this.storageCache[key]) {
            return null;
        }
        try {
            const obj = this.storageCache[key];
            return JSON.parse(obj);
        }
        catch (error) {
            return this.storageCache[key];
        }
    }
    remove(key) {
        delete this.storageCache[key];
        if (window['cordova']) {
            this.initNgForage();
        }
        this.ngf.removeItem(key).then(fulfilled => {
            delete this.ngf[key];
        }).catch(error => {
            console.error('Could not remove', key);
        });
    }
    clear() {
        this.storageCache = {};
        this.ngf.clear();
    }
    pluginCheck() {
        if (window['cordova'] && window['NativeStorage']) {
            this.nativeStorageI = window['NativeStorage'];
            // return true;
        }
        // this.initStorage();
    }
    getItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.getItem(key, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    setItemNs(key, value) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.setItem(key, value, result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    removeItemNs(key) {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.remove(key, (result) => {
                    resolve(result);
                }, (error) => {
                    reject(error);
                });
            }
        });
    }
    clearNs() {
        return new Promise((resolve, reject) => {
            if (window['cordova'] && window['NativeStorage']) {
                this.nativeStorageI.clear(result => {
                    resolve(result);
                }, error => {
                    reject(error);
                });
            }
        });
    }
    initNgForage() {
        let driverType = window['neutrinos']['environments']['properties']['NGFORAGE_MOBILE_DRIVER'] ? window['neutrinos']['environments']['properties']['NGFORAGE_MOBILE_DRIVER'] : "INDEXED_DB";
        this.ngfConfig.configure({
            name: 'MyApp',
            driver: [
                Driver[driverType],
            ]
        });
    }
    promiseReflect(promise) {
        return promise.then(resolved => { return { v: resolved, status: 'resolved' }; }, error => { return { e: error, status: 'rejected' }; });
    }
    clearLocalStorage() {
        this.remove('userObj');
        this.remove('accessToken');
        this.remove('refreshToken');
        this.remove('registrationId');
    }
    /**
     * Due to timing issues and circular dependency checkDeviceId is moved from NSystemService
    */
    checkDeviceId() {
        if (NSystemService.getInstance().checkDevice() === 'browser') {
            this._deviceUUID = this.getValue('uuid');
            if (!this._deviceUUID) {
                this._deviceUUID = new NUtility().generateUUID();
                this.setValue('uuid', this._deviceUUID);
            }
        }
        else {
            window['plugins'].uniqueDeviceID.get((uuid) => {
                this._deviceUUID = uuid;
                this.setValue('uuid', this._deviceUUID);
            });
        }
        return this._deviceUUID;
    }
    get deviceUUID() {
        return this._deviceUUID;
    }
}
NLocalStorageService.decorators = [
    { type: Injectable }
];
NLocalStorageService.ctorParameters = () => [
    { type: NgForageConfig },
    { type: NgForage },
    { type: NgForageCache }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibi1sb2NhbFN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9uZXV0cmlub3MvRG9jdW1lbnRzL25ldXRyaW5vcy1tb2R1bGVzLWFuZ3VsYXIvbmV1dHJpbm9zLXNlZWQtc2VydmljZXMvIiwic291cmNlcyI6WyJzcmMvYXBwL25ldXRyaW5vcy1zZWVkLXNlcnZpY2VzL24tbG9jYWxTdG9yYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFDLFFBQVEsRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUN6RSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFHNUMsTUFBTSxPQUFPLG9CQUFvQjtJQUsvQixZQUFvQixTQUEwQixFQUFtQixHQUFjLEVBQW1CLFFBQXdCO1FBQXRHLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQW1CLFFBQUcsR0FBSCxHQUFHLENBQVc7UUFBbUIsYUFBUSxHQUFSLFFBQVEsQ0FBZ0I7UUFIMUgsaUJBQVksR0FBUSxFQUFFLENBQUM7SUFJdkIsQ0FBQztJQUlELFdBQVc7UUFDVCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUNyQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDckI7WUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFLEVBQUU7Z0JBQzlDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFD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QUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVEOztNQUVFO0lBRUYsYUFBYTtRQUNYLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDLFdBQVcsRUFBRSxLQUFLLFNBQVMsRUFBRTtZQUM1RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFekMsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2FBQ3pDO1NBQ0Y7YUFBTTtZQUNMLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBVyxVQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztJQUMxQixDQUFDOzs7WUE3S0YsVUFBVTs7O1lBSHNCLGNBQWM7WUFBdkMsUUFBUTtZQUFFLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOU3lzdGVtU2VydmljZSB9IGZyb20gJy4vbi1zeXN0ZW0uc2VydmljZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge05nRm9yYWdlLCBOZ0ZvcmFnZUNhY2hlLCBOZ0ZvcmFnZUNvbmZpZywgRHJpdmVyfSBmcm9tICduZ2ZvcmFnZSc7XG5pbXBvcnQgeyBOVXRpbGl0eSB9IGZyb20gJy4vbi11dGlsLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTkxvY2FsU3RvcmFnZVNlcnZpY2Uge1xuXG4gIHN0b3JhZ2VDYWNoZTogYW55ID0ge307XG4gIHByaXZhdGUgX2RldmljZVVVSUQ7XG4gIHByaXZhdGUgbmF0aXZlU3RvcmFnZUk7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdmQ29uZmlnPzogTmdGb3JhZ2VDb25maWcsIHByaXZhdGUgcmVhZG9ubHkgbmdmPzogTmdGb3JhZ2UsIHByaXZhdGUgcmVhZG9ubHkgbmdmQ2FjaGU/OiBOZ0ZvcmFnZUNhY2hlKSB7XG4gIH1cblxuXG5cbiAgaW5pdFN0b3JhZ2UoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSkge1xuICAgICAgICB0aGlzLmluaXROZ0ZvcmFnZSgpO1xuICAgICAgfVxuICAgICAgdGhpcy5uZ2YuaXRlcmF0ZSgodmFsdWUsIGtleSwgaXRlcmF0b25OdW1iZXIpID0+IHtcbiAgICAgICAgdGhpcy5zdG9yYWdlQ2FjaGVba2V5XSA9IHZhbHVlO1xuICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICB0aGlzLmNoZWNrRGV2aWNlSWQoKTtcbiAgICAgICAgcmV0dXJuIHJlc29sdmUoJ2l0ZXJhdGlvbiBpcyBjb21wbGV0ZWQnKVxuICAgICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0U3RvcmFnZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlQ2FjaGU7XG4gIH1cblxuXG4gIHNldFZhbHVlKGtleSwgdmFsdWUpIHtcbiAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10pIHtcbiAgICAgIHRoaXMuaW5pdE5nRm9yYWdlKCk7XG4gICAgfVxuICAgIHRoaXMuc3RvcmFnZUNhY2hlW2tleV0gPSB2YWx1ZTtcbiAgICByZXR1cm4gdGhpcy5uZ2Yuc2V0SXRlbShrZXksIHZhbHVlKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIGVycm9yID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFZhbHVlKGtleSk6IGFueSB8IFByb21pc2U8YW55PiB7XG4gICAgaWYgKCF0aGlzLnN0b3JhZ2VDYWNoZVtrZXldKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IHRyeSB7XG4gICAgICBjb25zdCBvYmogPSB0aGlzLnN0b3JhZ2VDYWNoZVtrZXldXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShvYmopO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdG9yYWdlQ2FjaGVba2V5XTtcbiAgICB9XG4gIH1cblxuICByZW1vdmUoa2V5KSB7XG4gICAgZGVsZXRlIHRoaXMuc3RvcmFnZUNhY2hlW2tleV07XG4gICAgaWYgKHdpbmRvd1snY29yZG92YSddKSB7XG4gICAgICB0aGlzLmluaXROZ0ZvcmFnZSgpO1xuICAgIH1cbiAgICB0aGlzLm5nZi5yZW1vdmVJdGVtKGtleSkudGhlbihmdWxmaWxsZWQgPT4ge1xuICAgICAgZGVsZXRlIHRoaXMubmdmW2tleV07XG4gICAgfSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgY29uc29sZS5lcnJvcignQ291bGQgbm90IHJlbW92ZScsIGtleSk7XG4gICAgfSk7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnN0b3JhZ2VDYWNoZSA9IHt9O1xuICAgIHRoaXMubmdmLmNsZWFyKCk7XG4gIH1cblxuICBwcml2YXRlIHBsdWdpbkNoZWNrKCkge1xuICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSSA9IHdpbmRvd1snTmF0aXZlU3RvcmFnZSddO1xuICAgICAgLy8gcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIHRoaXMuaW5pdFN0b3JhZ2UoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SXRlbU5zKGtleSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAod2luZG93Wydjb3Jkb3ZhJ10gJiYgd2luZG93WydOYXRpdmVTdG9yYWdlJ10pIHtcbiAgICAgICAgdGhpcy5uYXRpdmVTdG9yYWdlSS5nZXRJdGVtKGtleSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHNldEl0ZW1OcyhrZXksIHZhbHVlKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh3aW5kb3dbJ2NvcmRvdmEnXSAmJiB3aW5kb3dbJ05hdGl2ZVN0b3JhZ2UnXSkge1xuICAgICAgICB0aGlzLm5hdGl2ZVN0b3JhZ2VJLnNldEl0ZW0oa2V5LCB2YWx1ZSwgcmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUl0ZW1OcyhrZXkpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkucmVtb3ZlKGtleSwgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgY2xlYXJOcygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHdpbmRvd1snY29yZG92YSddICYmIHdpbmRvd1snTmF0aXZlU3RvcmFnZSddKSB7XG4gICAgICAgIHRoaXMubmF0aXZlU3RvcmFnZUkuY2xlYXIocmVzdWx0ID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgIH0sIGVycm9yID0+IHtcbiAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIGluaXROZ0ZvcmFnZSgpIHtcbiAgICBsZXQgZHJpdmVyVHlwZSA9IHdpbmRvd1snbmV1dHJpbm9zJ11bJ2Vudmlyb25tZW50cyddWydwcm9wZXJ0aWVzJ11bJ05HRk9SQUdFX01PQklMRV9EUklWRVInXSA/IHdpbmRvd1snbmV1dHJpbm9zJ11bJ2Vudmlyb25tZW50cyddWydwcm9wZXJ0aWVzJ11bJ05HRk9SQUdFX01PQklMRV9EUklWRVInXSA6IFwiSU5ERVhFRF9EQlwiO1xuICAgIHRoaXMubmdmQ29uZmlnLmNvbmZpZ3VyZSh7XG4gICAgICBuYW1lOiAnTXlBcHAnLFxuICAgICAgZHJpdmVyOiBbXG4gICAgICAgIERyaXZlcltkcml2ZXJUeXBlXSxcbiAgICAgIF1cbiAgICB9KTtcblxuICB9XG5cbiAgcHJpdmF0ZSBwcm9taXNlUmVmbGVjdChwcm9taXNlKSB7XG4gICAgcmV0dXJuIHByb21pc2UudGhlbihyZXNvbHZlZCA9PiB7IHJldHVybiB7IHY6IHJlc29sdmVkLCBzdGF0dXM6ICdyZXNvbHZlZCcgfSB9LCBlcnJvciA9PiB7IHJldHVybiB7IGU6IGVycm9yLCBzdGF0dXM6ICdyZWplY3RlZCcgfSB9KVxuICB9XG5cbiAgY2xlYXJMb2NhbFN0b3JhZ2UoKSB7XG4gICAgdGhpcy5yZW1vdmUoJ3VzZXJPYmonKTtcbiAgICB0aGlzLnJlbW92ZSgnYWNjZXNzVG9rZW4nKTtcbiAgICB0aGlzLnJlbW92ZSgncmVmcmVzaFRva2VuJyk7XG4gICAgdGhpcy5yZW1vdmUoJ3JlZ2lzdHJhdGlvbklkJyk7XG4gIH1cblxuICAvKipcbiAgICogRHVlIHRvIHRpbWluZyBpc3N1ZXMgYW5kIGNpcmN1bGFyIGRlcGVuZGVuY3kgY2hlY2tEZXZpY2VJZCBpcyBtb3ZlZCBmcm9tIE5TeXN0ZW1TZXJ2aWNlXG4gICovXG5cbiAgY2hlY2tEZXZpY2VJZCgpIHtcbiAgICBpZiAoTlN5c3RlbVNlcnZpY2UuZ2V0SW5zdGFuY2UoKS5jaGVja0RldmljZSgpID09PSAnYnJvd3NlcicpIHtcbiAgICAgIHRoaXMuX2RldmljZVVVSUQgPSB0aGlzLmdldFZhbHVlKCd1dWlkJyk7XG5cbiAgICAgIGlmICghdGhpcy5fZGV2aWNlVVVJRCkge1xuICAgICAgICB0aGlzLl9kZXZpY2VVVUlEID0gbmV3IE5VdGlsaXR5KCkuZ2VuZXJhdGVVVUlEKCk7XG4gICAgICAgIHRoaXMuc2V0VmFsdWUoJ3V1aWQnLCB0aGlzLl9kZXZpY2VVVUlEKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgd2luZG93WydwbHVnaW5zJ10udW5pcXVlRGV2aWNlSUQuZ2V0KCh1dWlkKSA9PiB7XG4gICAgICAgIHRoaXMuX2RldmljZVVVSUQgPSB1dWlkO1xuICAgICAgICB0aGlzLnNldFZhbHVlKCd1dWlkJywgdGhpcy5fZGV2aWNlVVVJRCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX2RldmljZVVVSUQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGRldmljZVVVSUQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RldmljZVVVSUQ7XG4gIH1cbn1cbiJdfQ==